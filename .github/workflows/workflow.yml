on:
  push:
    branches:
      - main

jobs:

  build:
    name: Build, push, and deploy
    runs-on: ubuntu-latest
    steps:

    - name: Checkout main
      uses: actions/checkout@v4

    - name: Update SHA
      run: echo $GITHUB_SHA > $GITHUB_WORKSPACE/helm/notes

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}


    - name: Build and push
      id: docker_build
      uses: docker/build-push-action@v2
      with:
          context: .
          push: true
          tags: |
            kasparov112000/learnbytesting-video-transcription-docker:latest
            kasparov112000/learnbytesting-video-transcription-docker:${{ github.sha }}
          secrets: |
            GIT_AUTH_TOKEN=${{ secrets.MYTOKEN }}

    - name: Save DigitalOcean kubeconfig with short-lived credentials
      run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 3b23a2dd-3391-4d1a-a478-e2a5564de99c

    - name: Wait for image availability
      run: |
        echo "Waiting for image to be available on DockerHub..."
        for i in {1..30}; do
          if docker manifest inspect kasparov112000/learnbytesting-video-transcription-docker:${{ github.sha }} > /dev/null 2>&1; then
            echo "Image is available!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 10
        done

    - name: Prep helm chart
      run: |
          mv ./helm/Chart.yaml ./helm/Chart.old.yaml &&
          cat ./helm/Chart.old.yaml | grep -v appVersion > ./helm/Chart.yaml &&
          echo -e "\r\nappVersion: v${GITHUB_REF##*/}\r\n" >> ./helm/Chart.yaml &&
          cat ./helm/Chart.yaml
    - name: Deploy
      uses: WyriHaximus/github-action-helm3@v2
      with:
          exec: helm upgrade video-transcription ./helm/ --install --wait --atomic --force --set=app.name=video-transcription --set=image.tag=${{ github.sha }} --values=./helm/values.yaml
          kubeconfig: '${{ secrets.KUBECONFIG }}'
